<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpaceStaticService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">blog</a> &gt; <a href="index.source.html" class="el_package">com.hab.blog.feature.v1.space</a> &gt; <span class="el_source">SpaceStaticService.java</span></div><h1>SpaceStaticService.java</h1><pre class="source lang-java linenums">package com.hab.blog.feature.v1.space;

import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
<span class="nc" id="L10">public class SpaceStaticService {</span>

    /** 列表静态数据 */
    public Map&lt;String, Object&gt; mockSpaceList(String category, int page, int pageSize) {
<span class="nc" id="L14">        Map&lt;String, Object&gt; json = new HashMap&lt;&gt;();</span>

<span class="nc" id="L16">        json.put(&quot;page&quot;, page);</span>
<span class="nc" id="L17">        json.put(&quot;pageSize&quot;, pageSize);</span>
<span class="nc" id="L18">        json.put(&quot;total&quot;, 42);</span>
<span class="nc" id="L19">        json.put(&quot;data&quot;, List.of(skyDemo(), rainForest()));</span>

<span class="nc" id="L21">        return json;</span>
    }

    /** 详情静态数据 */
    public Map&lt;String, Object&gt; mockSpaceDetail(String id) {
        // 简单判断返回
<span class="nc bnc" id="L27" title="All 2 branches missed.">        if (&quot;rainforest_01&quot;.equals(id)) {</span>
<span class="nc" id="L28">            return rainForest();</span>
        }
        // 默认星空
<span class="nc" id="L31">        return skyDemo();</span>
    }

    // ===== 静态条目构造 =====
    private Map&lt;String, Object&gt; skyDemo() {
<span class="nc" id="L36">        Map&lt;String, Object&gt; m = new HashMap&lt;&gt;();</span>
<span class="nc" id="L37">        m.put(&quot;id&quot;, &quot;sky_demo1&quot;);</span>
<span class="nc" id="L38">        m.put(&quot;name&quot;, &quot;浩瀚星空&quot;);</span>
<span class="nc" id="L39">        m.put(&quot;description&quot;, &quot;置身银河深处，畅享极致暗黑观影体验。&quot;);</span>
<span class="nc" id="L40">        m.put(&quot;thumbnailURL&quot;, &quot;https://cdn.example.com/thumbs/sky_demo1.jpg&quot;);</span>
<span class="nc" id="L41">        m.put(&quot;fileURL&quot;, &quot;https://cdn.example.com/usdz/sky_demo1_v2.usdz&quot;);</span>
<span class="nc" id="L42">        m.put(&quot;fileSize&quot;, 14875632);</span>
<span class="nc" id="L43">        m.put(&quot;version&quot;, 2);</span>
<span class="nc" id="L44">        m.put(&quot;sha256&quot;, &quot;ab34ef90...&quot;);</span>
<span class="nc" id="L45">        m.put(&quot;tags&quot;, List.of(&quot;dark&quot;, &quot;sci-fi&quot;));</span>
<span class="nc" id="L46">        m.put(&quot;rating&quot;, 4.7);</span>
<span class="nc" id="L47">        m.put(&quot;ratingCount&quot;, 132);</span>
<span class="nc" id="L48">        m.put(&quot;updatedAt&quot;, &quot;2025-06-04T12:30:00Z&quot;);</span>
<span class="nc" id="L49">        return m;</span>
    }

    private Map&lt;String, Object&gt; rainForest() {
<span class="nc" id="L53">        Map&lt;String, Object&gt; m = new HashMap&lt;&gt;();</span>
<span class="nc" id="L54">        m.put(&quot;id&quot;, &quot;rainforest_01&quot;);</span>
<span class="nc" id="L55">        m.put(&quot;name&quot;, &quot;雨林秘境&quot;);</span>
<span class="nc" id="L56">        m.put(&quot;description&quot;, &quot;热带雨林，阳光穿透树冠。&quot;);</span>
<span class="nc" id="L57">        m.put(&quot;thumbnailURL&quot;, &quot;https://cdn.example.com/thumbs/rainforest_01.jpg&quot;);</span>
<span class="nc" id="L58">        m.put(&quot;fileURL&quot;, &quot;https://cdn.example.com/usdz/rainforest_01_v1.usdz&quot;);</span>
<span class="nc" id="L59">        m.put(&quot;fileSize&quot;, 12345678);</span>
<span class="nc" id="L60">        m.put(&quot;version&quot;, 1);</span>
<span class="nc" id="L61">        m.put(&quot;sha256&quot;, &quot;cdef1234...&quot;);</span>
<span class="nc" id="L62">        m.put(&quot;tags&quot;, List.of(&quot;nature&quot;, &quot;bright&quot;));</span>
<span class="nc" id="L63">        m.put(&quot;rating&quot;, 4.3);</span>
<span class="nc" id="L64">        m.put(&quot;ratingCount&quot;, 56);</span>
<span class="nc" id="L65">        m.put(&quot;updatedAt&quot;, &quot;2025-05-28T09:10:00Z&quot;);</span>
<span class="nc" id="L66">        return m;</span>
    }
    // 省略前面列表 / 详情代码

    /* ========== 内存级评分缓存 ========== */
<span class="nc" id="L71">    private final Map&lt;String, double[]&gt; ratingCache = new HashMap&lt;&gt;();</span>
// key=id, value[0]=avg, value[1]=count

    public Map&lt;String, Object&gt; addRating(String id, int value) {
<span class="nc" id="L75">        double[] arr = ratingCache.computeIfAbsent(id, k -&gt; new double[]{4.5, 100}); // 默认基值</span>
<span class="nc" id="L76">        arr[0] = (arr[0] * arr[1] + value) / (arr[1] + 1); // 新均值</span>
<span class="nc" id="L77">        arr[1] += 1;                                       // 计数 +1</span>

<span class="nc" id="L79">        Map&lt;String, Object&gt; res = new HashMap&lt;&gt;();</span>
<span class="nc" id="L80">        res.put(&quot;rating&quot;, round(arr[0], 1));</span>
<span class="nc" id="L81">        res.put(&quot;ratingCount&quot;, (int) arr[1]);</span>
<span class="nc" id="L82">        return res;</span>
    }

    /* ========== 内存级评论缓存 ========== */
<span class="nc" id="L86">    private final Map&lt;String, List&lt;Map&lt;String, Object&gt;&gt;&gt; commentCache = new HashMap&lt;&gt;();</span>

    public Map&lt;String, Object&gt; getComments(String id, int page, int pageSize) {
<span class="nc" id="L89">        List&lt;Map&lt;String, Object&gt;&gt; list =</span>
<span class="nc" id="L90">                commentCache.computeIfAbsent(id, k -&gt; defaultComments());</span>
<span class="nc" id="L91">        int total = list.size();</span>

<span class="nc" id="L93">        int from = Math.max(0, (page - 1) * pageSize);</span>
<span class="nc" id="L94">        int to = Math.min(total, from + pageSize);</span>

<span class="nc" id="L96">        Map&lt;String, Object&gt; res = new HashMap&lt;&gt;();</span>
<span class="nc" id="L97">        res.put(&quot;page&quot;, page);</span>
<span class="nc" id="L98">        res.put(&quot;pageSize&quot;, pageSize);</span>
<span class="nc" id="L99">        res.put(&quot;total&quot;, total);</span>
<span class="nc" id="L100">        res.put(&quot;data&quot;, list.subList(from, to));</span>
<span class="nc" id="L101">        return res;</span>
    }

    public Map&lt;String, Object&gt; addComment(String id, String content, int rating) {
<span class="nc" id="L105">        List&lt;Map&lt;String, Object&gt;&gt; list =</span>
<span class="nc" id="L106">                commentCache.computeIfAbsent(id, k -&gt; defaultComments());</span>

<span class="nc" id="L108">        Map&lt;String, Object&gt; newCmt = new HashMap&lt;&gt;();</span>
<span class="nc" id="L109">        newCmt.put(&quot;id&quot;, &quot;cmt_&quot; + String.format(&quot;%03d&quot;, list.size() + 1));</span>
<span class="nc" id="L110">        newCmt.put(&quot;author&quot;, &quot;You&quot;);</span>
<span class="nc" id="L111">        newCmt.put(&quot;content&quot;, content);</span>
<span class="nc" id="L112">        newCmt.put(&quot;rating&quot;, rating);</span>
<span class="nc" id="L113">        newCmt.put(&quot;createdAt&quot;, java.time.ZonedDateTime.now().toString());</span>

<span class="nc" id="L115">        list.add(0, newCmt);          // 置顶</span>
<span class="nc" id="L116">        return newCmt;</span>
    }

    /* ===== 默认两条示例评论 ===== */
    private List&lt;Map&lt;String, Object&gt;&gt; defaultComments() {
<span class="nc" id="L121">        List&lt;Map&lt;String, Object&gt;&gt; l = new java.util.ArrayList&lt;&gt;();</span>
<span class="nc" id="L122">        l.add(Map.of(</span>
                &quot;id&quot;, &quot;cmt_001&quot;,
                &quot;author&quot;, &quot;Alice&quot;,
                &quot;content&quot;, &quot;夜空效果太棒了！&quot;,
<span class="nc" id="L126">                &quot;rating&quot;, 5,</span>
                &quot;createdAt&quot;, &quot;2025-06-05T08:20:00Z&quot;
        ));
<span class="nc" id="L129">        l.add(Map.of(</span>
                &quot;id&quot;, &quot;cmt_002&quot;,
                &quot;author&quot;, &quot;Bob&quot;,
                &quot;content&quot;, &quot;建议再把星云做亮一点。&quot;,
<span class="nc" id="L133">                &quot;rating&quot;, 4,</span>
                &quot;createdAt&quot;, &quot;2025-06-05T09:12:00Z&quot;
        ));
<span class="nc" id="L136">        return l;</span>
    }

    /* ===== 工具：保留 n 位小数 ===== */
    private double round(double v, int n) {
<span class="nc" id="L141">        double p = Math.pow(10, n);</span>
<span class="nc" id="L142">        return Math.round(v * p) / p;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>